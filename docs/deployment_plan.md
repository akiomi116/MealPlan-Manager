# デプロイ・運用・認証戦略ドキュメント

これまで議論された、本番環境へのデプロイ構成、Dockerの扱い、および認証方式に関する決定事項と推奨案をまとめたドキュメントです。

## 1. 全体アーキテクチャ (推奨構成)

フロントエンドとバックエンドをそれぞれ得意なプラットフォームに配置し、データベースと認証をSupabaseに統合することで、**「低コスト・高パフォーマンス・運用管理の簡素化」**を実現します。

| レイヤー | 技術スタック | ホスティング先 (本番) | 理由 |
| :--- | :--- | :--- | :--- |
| **Frontend** | Next.js | **Vercel** | Next.jsの開発元であり、設定不要で最速のデプロイが可能。 |
| **Backend** | Python (FastAPI) | **Render** | Pythonアプリのホスティングが容易で、無料枠も充実しているため。 |
| **Database** | PostgreSQL | **Supabase** | 認証機能とセットで利用でき、永続的なDBが無料枠で確保できるため。 |
| **Auth** | Supabase Auth | **Supabase** | DBとの統合管理が可能で、マジックリンク等の老人向けログインが容易。 |

---

## 2. Docker の位置付け

### 開発環境 (Local)
*   **使用目的**: ローカルPC上で手軽にPostgreSQLデータベースを起動するために使用 (`docker-compose.yml`)。
*   **メリット**: Windowsに直接DBをインストールせず、環境を汚さずに開発・テストが可能。

### 本番環境 (Production)
*   **使用方針**: **Dockerは使用しません (Native Deployment)。**
*   **理由**:
    *   **Vercel / Render** は、Dockerを使わずとも GitHub と連携するだけで、ソースコードから直接ビルド・デプロイできる仕組み (Git-based Deployment) が標準です。
    *   この規模のアプリでは、Dockerコンテナを本番で管理するオーバーヘッド（設定ファイルの管理、ビルド時間の増加）を避ける方が賢明です。

---

## 3. 認証・データベース戦略

### 課題と解決策
*   **課題**: Renderの無料PostgreSQLデータベースは90日でデータが消える制限がある。
*   **解決策**: データベースを **Supabase** に移行する。

### Supabase 採用のメリット
1.  **DBの一元管理**: 認証用ユーザーデータと、アプリのデータ（献立・履歴）を同じPostgreSQL上で結合して扱えます。これによる実装コスト削減効果は大きいです。
2.  **高齢者向けUI (Magic Link)**:
    *   パスワードを覚えなくて済む「メールアドレス入力 → 届いたリンクをクリック」だけのログイン方式（マジックリンク）が標準で利用可能です。
3.  **コスト**: 認証もDBも無料枠が大きく（月50,000アクティブユーザー / 500MB）、個人開発〜小規模運用には十分です。

### Clerk との比較 (参考)
*   **Clerk**: 開発体験は最高ですが、「認証」しか提供しません。別途データベース（Neonなど）の契約・管理が必要となり、管理するサービスが1つ増えてしまいます。
*   **結論**: 「管理の手間を減らす」という観点から、今回は **Supabase** を推奨します。

---

## 4. 今後のステップ (移行・デプロイ手順)

以下の順序で進めることを推奨します。

1.  **Supabase プロジェクト作成**:
    *   Web上でプロジェクトを作成し、APIキーとDB接続情報を取得。
2.  **環境変数の切り替え**:
    *   `backend/.env` の `DATABASE_URL` を、ローカルDockerからSupabaseのものに書き換え。
    *   これだけで、アプリ開発中はローカル、DBはクラウド(Supabase)というハイブリッド構成になり、デプロイ準備が整います。
3.  **デプロイ設定**:
    *   **Vercel**: フロントエンドのリポジトリを接続。
    *   **Render**: バックエンドのリポジトリを接続し、環境変数を設定。
